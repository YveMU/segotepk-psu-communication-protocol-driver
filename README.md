# Segotep PSU Monitor (鑫谷电源监控脚本)

这是一个用于在 Linux 环境下读取和监控鑫谷（Segotep）电源（如昆仑系列 DM-850G）状态的非官方 Python 脚本。本项目基于对原厂软件通讯协议的抓包与反向工程分析。

## 免责声明
本项目与鑫谷（Segotep）官方无关。所有数据均通过逆向分析 USB UART 通讯得到，使用本脚本造成的一切后果由使用者自行承担。

## 硬件连接
在 Linux 下，设备通常被识别为 `/dev/ttyUSBx`，具体端口号请参考数据得到

## ⚙️ 通讯协议分析
通过筛选 `IRP_MJ_READ` 包并分析 `IOCTL_SERIAL_SET_BAUD_RATE` 和 `SET_LINE_CONTROL` 日志，确定串口通讯参数如下：

| 参数 | 值 |
| :--- | :--- |
| **Baud Rate (波特率)** | 115200 |
| **Data Bits (数据位)** | 8 |
| **Stop Bits (停止位)** | 1 |
| **Parity (校验位)** | None |

### 数据包结构
通讯采用轮询机制。所有数据包遵循特定的头部和校验规则。
经统计分析，主要存在 **0x02, 0x03, 0x04, 0x05** 四种类型的数据包。

#### 1. 设备信息 (0x03 & 0x05)
这两种包通常在初始化阶段发送，包含电源的型号与序列号。

*   **0x03 (型号 Model):**
    *   Hex: `55 7e 1b 03 ...`
    *   Payload ASCII 解码: `DM-850G ... Segotep`
*   **0x05 (序列号 Serial Number):**
    *   Hex: `55 7e 12 05 ...`
    *   Payload ASCII 解码: `SBSF7B50C00....`

#### 2. 电源监控数据 （0x02 & 0x04）
#### **Packet 0x02 (电气参数)**
*Header(2) + Len(1) + Type(1) + Payload...*

| 偏移 (相对于Type后) | 长度 | 解析公式 | 含义 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| **0** | U16 | / 1000 | **+3.3V 电压 (V)** | |
| **2** | U16 | / 1000 | **+5V 电压 (V)** | |
| **4** | U16 | / 1000 | **+12V 电压 (V)** | |
| **6** | U16 | / 1000 | **+5V SB 电压 (V)** | |
| **8** | U16 | / 1000 | **+3.3V 电流 (A)** | |
| **10** | U16 | / 1000 | **+5V 电流 (A)** | |
| **12** | U16 | / 1000 | **+12V 电流 (A)** | |
| **14** | U16 | / 10 | **AC 频率 (Hz)** | |
| **16** | U16 | raw | *AC 电压 ADC* | 随负载降低 |
| **18** | U16 | raw | *AC 电流 ADC* | 随负载升高 |
| **20** | U16 | raw | *功率因数校正值* | 稳定在 7500 左右 |
| **22** | U16 | / 10 | **AC 输入电压 (V)** | |
| **24** | U16 | **x 30** | **风扇转速 (RPM)** | **关键发现** |

#### **Packet 0x04 (扩展状态)**
*Payload 结构: Type(1) + Mode(1) + Status(1) + U16 Data...*

| 偏移 (相对于Type后) | 长度 | 解析公式 | 含义 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| **0** | U8 | Raw | **风扇模式 (Mode)** | 3=High/Custom, 4=Ramp, 5=Mute, 6=Auto? |
| **1** | U8 | Raw | **负载状态位** | 发生高负载时改变 |
| **2** | U16 | / 10 | **Temp 1 (Main)** | 对应 "High" |
| **4** | U16 | Raw | *Fan Target PWM* | 对应 CSV `v01` |
| **6** | U16 | Raw | *Threshold 1* | 恒定 612 |
| **8** | U16 | Raw | *Threshold 2* | 恒定 256 |
| **10** | U16 | Raw | *未知常数* | 恒定 8132 |
| **12** | U16 | / 10 | **Temp 2 (Sec)** | 对应 "Low" / MOS温度 (CSV `v06`) |
| **14** | U16 | Raw | *未知* | 恒定 73x 或 565? (此处有移位) |
| **16** | U16 | **/ 10** | **输入功率 (W)** | CSV `v07` / StressNG `v06`。看数值在 700-1800 之间的那个 |
| **24** | U16 | **/ 100**| **Temp 3 (Air)** | 对应 CSV `v11` (2977 -> 29.77C) |

---

## 🚫 已知问题与限制

在结合 stress-ng 进行 FPU 负载测试、调节风扇转速并对比不同传感器数据后，得出以下结论：

1.  **DC 输出电流与功率计算异常**：
    *   通过 0x02 包中的 12V 与 5V 电流读数计算出的 DC 功耗与墙插功耗存在显著差异。
    *   尝试过 `/256` (12V) 或 `/4096` (5V) 等多种 ADC 换算推测，计算出的电源转换效率甚至会超过 100%。
    *   **结论**：0x02 包中的电流读数单位不明或需要特定非线性校准，**不可用于精确功耗计算**。

2.  **传感器特性**：
    *   **Low 传感器**：该温度字段随功率（及风扇转速）提升而下降，不适合作为过热保护参考。
    *   **Airflow 传感器**：对环境变化极其不敏感。

3.  **可靠监控指标**：
    目前仅推荐监控以下被证实准确的参数：
    *   ✅ 电压：+3.3V, +5V, +12V, +5V SB
    *   ✅ AC 输入：电压 (V), 频率 (Hz), **功率 (Watt, 来自 0x04 包)**
    *   ✅ 风扇：实时转速 (RPM)
    *   ✅ 温度：High (主) 传感器

## 🚀 使用方法

*(此处可以补充您的脚本运行命令，例如)*

```bash
# 安装依赖
pip install pyserial

# 运行监控
python3 psu_logger.py
```

## 📝 贡献
欢迎提交 Issue 或 Pull Request 来完善更多型号的识别或修正电流计算公式。
